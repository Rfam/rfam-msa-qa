name: Validate and Fix Stockholm Files

on:
  push:
    branches-ignore:
      - main
    paths:
      - '**.so'
      - '**.sto'
      - '**.stk'
      - '**.stockholm'

jobs:
  validate-and-fix:
    name: Validate and Fix Stockholm MSA Files
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Conda
        uses: conda-incubator/setup-miniconda@v3
        with:
          environment-file: environment.yml
          activate-environment: rfam-msa-qa
          channels: bioconda,conda-forge,defaults

      - name: Prepare Rfam CM database
        shell: bash -l {0}
        run: |
          gunzip -k models/15.1/Rfam.cm.gz
          cmpress models/15.1/Rfam.cm

      - name: Get changed Stockholm files
        id: changed-files
        run: |
          BEFORE="${{ github.event.before }}"
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            BEFORE="origin/main"
          fi

          # Get changed alignment files, excluding generated outputs
          git diff --name-only --diff-filter=ACMRT "$BEFORE" "${{ github.sha }}" | \
            grep -E '\.(so|sto|stk|stockholm)$' | \
            grep -v '_corrected\.' > changed_files.txt || true

          if [ -s changed_files.txt ]; then
            echo "has_files=true" >> $GITHUB_OUTPUT
            echo "Changed Stockholm files:"
            cat changed_files.txt
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
            echo "No Stockholm files changed"
          fi

      - name: Check files are in tests/ directory
        if: steps.changed-files.outputs.has_files == 'true'
        run: |
          INVALID=$(grep -v '^tests/' changed_files.txt || true)
          if [ -n "$INVALID" ]; then
            echo "::error::Stockholm files must be placed in the tests/ directory. Found files outside tests/:"
            echo "$INVALID"
            exit 1
          fi

      - name: Validate and fix Stockholm files
        if: steps.changed-files.outputs.has_files == 'true'
        shell: bash -l {0}
        run: |
          while IFS= read -r file; do
            echo "========================================="
            echo "Processing: $file"
            echo "========================================="
            python3 validate_stockholm.py -v --fix --cm-db models/15.1/Rfam.cm "$file"
          done < changed_files.txt

      - name: Commit corrected files and reports
        if: steps.changed-files.outputs.has_files == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          find tests/ \( -name '*_corrected.*' -o -name '*_Report.txt' \) -exec git add {} +
          if git diff --cached --quiet; then
            echo "No corrected files to commit"
          else
            git commit -m "Add validation reports and corrected alignments [skip ci]"
            git push
          fi

      - name: Report
        if: steps.changed-files.outputs.has_files == 'false'
        run: |
          echo "No Stockholm files to process"
